<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeritasLens | Media Forensics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        .navbar { background-color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: 700; letter-spacing: 0.5px; }

        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { background-color: white; border-bottom: 1px solid #eee; font-weight: 600; border-radius: 12px 12px 0 0 !important; }

        /* ~~~ Authenticity Meter ~~~ */

        .meter-container { background: #e9ecef; border-radius: 20px; height: 30px; position: relative; overflow: hidden; }
        .meter-fill { height: 100%; border-radius: 20px; transition: width 1.0s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; color: white; font-weight: bold; }
        .bg-safe { background: linear-gradient(90deg, #56ab2f, #a8e063); }
        .bg-warn { background: linear-gradient(90deg, #fceabb, #f8b500); color: #5d4037; }
        .bg-fake { background: linear-gradient(90deg, #cb2d3e, #ef473a); }

        /* ~~~ Flag Cards ~~~ */
        
        .flag-card { border-left: 5px solid; background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .flag-critical { border-color: #dc3545; background-color: #fff5f5; }
        .flag-high { border-color: #fd7e14; background-color: #fffbf2; }
        .flag-info { border-color: #0dcaf0; background-color: #f0faff; }
        .badge-entity { background-color: #e9ecef; color: #495057; margin: 0 5px 5px 0; padding: 8px 12px; font-weight: 500; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand"><i class="fas fa-shield-alt me-2"></i>VeritasLens <small class="opacity-75 fw-light">| Forensic Dashboard</small></span>
    </div>
</nav>

<div class="container pb-5">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header py-3">1. Upload Evidence</div>
                <div class="card-body">
                    <form id="analyzeForm">
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">IMAGE SOURCE</label>
                            <input class="form-control" type="file" id="imageInput" accept="image/*" required>
                            <div class="mt-3 text-center bg-light rounded p-2" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                <img id="preview" class="img-fluid rounded d-none" style="max-height: 250px;">
                                <span id="placeholder-text" class="text-muted small">No image selected</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted small fw-bold">CLAIM / CAPTION</label>
                            <textarea class="form-control" id="captionInput" rows="3" placeholder="e.g. 'Breaking: Riot in downtown Madrid'"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
                            <i class="fas fa-search me-2"></i>RUN FORENSIC ANALYSIS
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <span>2. Analysis Report</span>
                    <span id="statusBadge" class="badge bg-secondary">Idle</span>
                </div>

                <div class="card-body">
                    <div id="loading" class="text-center d-none py-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                        <h5 class="text-dark">Analyzing Content...</h5>
                        <p class="text-muted small">Performing ELA Forensic Scan • Checking AI artifacts • Verifying Logic</p>
                    </div>

                    <div id="resultsArea" class="d-none">

                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold small text-muted">AI GENERATION PROBABILITY</span>
                                <span id="aiScoreText" class="fw-bold">0%</span>
                            </div>
                            <div class="meter-container">
                                <div id="aiScoreBar" class="meter-fill bg-safe" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="card mb-4 border-warning" style="background: #fffdf5;">
                            <div class="card-body">
                                <h6 class="fw-bold text-muted small mb-3"><i class="fas fa-fingerprint me-2"></i>DIGITAL TAMPERING (ELA HEATMAP)</h6>
                                <div class="row align-items-center">
                                    <div class="col-md-4 text-center">
                                        <img id="elaImage" class="img-fluid rounded border shadow-sm" style="max-height: 150px;">
                                    </div>
                                    <div class="col-md-8">
                                        <p class="small text-muted mb-0">
                                            <strong>How to read this:</strong> This heatmap highlights "error levels" in JPEG compression.
                                            Uniform darkness/noise is good. <br>
                                            <span class="text-danger fw-bold">Bright white patches</span> (that don't match edges) often indicate spliced/pasted objects (Photoshop edits).
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-7">
                                <h6 class="fw-bold text-muted small mb-3">INCONSISTENCY FLAGS</h6>
                                <div id="flagsList"></div>
                            </div>
                            <div class="col-md-5">
                                <h6 class="fw-bold text-muted small mb-3">AI VISUAL SUMMARY</h6>
                                <div class="p-3 bg-light rounded border mb-4">
                                    <i class="fas fa-robot text-primary me-2"></i>
                                    <span id="aiCaption" class="fst-italic text-dark small">...</span>
                                </div>
                                <h6 class="fw-bold text-muted small mb-2">DETECTED ENTITIES</h6>
                                <div id="entitiesList"></div>
                            </div>
                        </div>
                    </div>

                    <div id="emptyState" class="text-center py-5">
                        <i class="fas fa-microscope fa-3x text-muted mb-3 opacity-25"></i>
                        <p class="text-muted">Upload media to begin verification.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('imageInput').onchange = evt => {
        const [file] = document.getElementById('imageInput').files
        if (file) {
            document.getElementById('preview').src = URL.createObjectURL(file)
            document.getElementById('preview').classList.remove('d-none')
            document.getElementById('placeholder-text').classList.add('d-none')
        }
    }

    document.getElementById('analyzeForm').onsubmit = async (e) => {
        e.preventDefault();
        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('resultsArea').classList.add('d-none');
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('statusBadge').innerText = 'Processing...';
        document.getElementById('statusBadge').className = 'badge bg-warning text-dark';

        const formData = new FormData();
        formData.append("file", document.getElementById('imageInput').files[0]);
        formData.append("caption", document.getElementById('captionInput').value);

        try {
            const response = await fetch("/analyze", { method: "POST", body: formData });
            const data = await response.json();

            //  disp AI Score
            const score = data.ai_generated_probability;
            const bar = document.getElementById('aiScoreBar');
            const scoreText = document.getElementById('aiScoreText');
            bar.style.width = score + "%";
            scoreText.innerText = score + "%";
            if(score < 20) bar.className = "meter-fill bg-safe";
            else if (score < 70) bar.className = "meter-fill bg-warn";
            else bar.className = "meter-fill bg-fake";

            // disp ELA Heatmap
            document.getElementById('elaImage').src = data.ela_heatmap;

            // disp Flags
            const flagsContainer = document.getElementById('flagsList');
            flagsContainer.innerHTML = '';
            if (data.inconsistencies.length === 0) {
                flagsContainer.innerHTML = `<div class="alert alert-success d-flex align-items-center"><i class="fas fa-check-circle fa-2x me-3"></i><div><strong>Verified</strong><br><small>Visuals align with the text claim.</small></div></div>`;
            } else {
                data.inconsistencies.forEach(flag => {
                    let cardClass = 'flag-info';
                    let icon = 'fa-info-circle';

                    // setting colors based on severity....
                    
                    if (flag.severity === 'Critical') { cardClass = 'flag-critical'; icon = 'fa-exclamation-triangle'; }
                    else if (flag.severity === 'High') { cardClass = 'flag-high'; icon = 'fa-exclamation-circle'; }

                    // Logic to set icons based on Type...

                    if (flag.type.includes('Recycled')) icon = 'fa-recycle';
                    if (flag.type.includes('Location')) icon = 'fa-map-marker-alt';
                    if (flag.type.includes('AI')) icon = 'fa-robot';
                    if (flag.type.includes('Language')) icon = 'fa-language';
                    if (flag.type.includes('Logical')) icon = 'fa-brain';

                    const div = document.createElement('div');
                    div.className = `flag-card ${cardClass}`;
                    div.innerHTML = `<div class="d-flex"><div class="me-3"><i class="fas ${icon} fa-lg"></i></div><div><strong class="text-uppercase small d-block mb-1">${flag.type}</strong><span class="small">${flag.details}</span></div></div>`;
                    flagsContainer.appendChild(div);
                });
            }

            //  ~~~~ details ~~~

            document.getElementById('aiCaption').innerText = '"' + data.ai_generated_caption + '"';
            const entContainer = document.getElementById('entitiesList');
            entContainer.innerHTML = '';
            const entDict = data.detected_entities;
            let hasEnt = false;
            if(entDict.GPE) entDict.GPE.forEach(e => { entContainer.innerHTML += `<span class="badge badge-entity"><i class="fas fa-map-marker-alt me-1"></i>${e}</span>`; hasEnt = true; });
            if(entDict.DATE) entDict.DATE.forEach(e => { entContainer.innerHTML += `<span class="badge badge-entity"><i class="far fa-calendar-alt me-1"></i>${e}</span>`; hasEnt = true; });
            if(!hasEnt) entContainer.innerHTML = '<span class="text-muted small">No specific entities found.</span>';

            document.getElementById('loading').classList.add('d-none');
            document.getElementById('resultsArea').classList.remove('d-none');
            document.getElementById('statusBadge').innerText = 'Complete';
            document.getElementById('statusBadge').className = 'badge bg-success';

        } catch (err) {
            console.error(err);
            alert("Analysis failed. Check Colab logs for error.");
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('statusBadge').innerText = 'Error';
            document.getElementById('statusBadge').className = 'badge bg-danger';
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>